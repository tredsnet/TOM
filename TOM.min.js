(function(window){var scopeList=["core","interface"];for(var i in scopeList){window[scopeList[i]]={__scopeName__:scopeList[i]}}var TOM=window.TOM={_options:{boot:{log:true,warning:true,allowEvents:["complete"]},classes:{log:false,warning:true,allowEvents:["create","pre-constructor","post-constructor"]},processor:{log:true,warning:true,allowEvents:[]},commutator:{log:false,warning:true,allowEvents:[]}},_callbackList:[],_clone:function(obj){if(obj===null||typeof obj!=="object"){return obj}if(obj instanceof Date){var copy=new Date;copy.setTime(obj.getTime());return copy}if(obj instanceof Array){var copy=[];for(var i=0,len=obj.length;i<len;++i){copy[i]=this._clone(obj[i])}return copy}if(obj instanceof Object){var copy={};for(var attr in obj){if(obj.hasOwnProperty(attr)){copy[attr]=this._clone(obj[attr])}}return copy}throw new Error("Не удаётся скопировать объект! Не поддерживаемый формат.")},_objectLength:function(obj){var count=0;for(var i in obj){count++}return count},_log:function(module,type,msg){if(this._callbackList!==undefined&&this._callbackList["log"]instanceof Function){this._callbackList["log"].apply(this,[type,msg])}else if(this._options[module].log&&window.console!==undefined){console[type](msg)}return this},_error:function(module,errorMsg,errorObj){var msg=errorObj!==undefined&&errorObj.data!==undefined?'Ошибка ( "'+errorMsg+'" ) - "'+errorObj.data.src+'".':errorMsg;if(this._callbackList!==undefined&&this._callbackList["error"]instanceof Function){this._callbackList["error"].apply(this,[msg,errorObj])}else{throw new Error(msg,errorObj)}return this},_callback:function(module,event,callback){var allowEvents=(this._options[module].allowEvents||[]).concat(["log","error"]);if(allowEvents.indexOf(event)<0||!(callback instanceof Function)){this.error("Ошибка при установке обработчика событий!");return}return this._callbackList.push({module:module,event:event,callback:callback})},_triggerCallback:function(module,event,args,context){for(var i in this._callbackList){if(this._callbackList[i].module===module&&this._callbackList[i].event===event){if(this._callbackList[i].callback instanceof Function){this._callbackList[i].callback.apply(context instanceof Object?context:TOM[module],args)}}}return this},_removeCallback:function(event){delete this._callbackList[event];return this}};TOM.boot={_moduleList:[],_moduleLoadedStates:[],_fileLoadedStates:[],_modulesCallbackList:[],_monitoringTimer:undefined,_completeTimer:undefined,_options:{baseURL:"",cache:true},_log:function(type,msg){TOM._log("boot",type,msg);return this},_error:function(errorMsg,errorObj){TOM._error("boot",errorMsg,errorObj);return this},_triggerCallback:function(event,args){TOM._triggerCallback("boot",event,args);return this},callback:function(event,callback){TOM._callback("boot",event,callback);return this},removeCallback:function(event){TOM._removeCallback("boot",event);return this},options:function(option,value){if(this._options[option]!==undefined){this._options[option]=value}return this},load:function(dir,names,callback){var context=this,names=names instanceof Array?names:[names],loadList=this._prepareModuleList(names,dir),callback=callback instanceof Function?callback:function(){};for(var i in loadList){var moduleData=loadList[i];this._moduleList[moduleData.name]=TOM._clone(loadList[i]);this._moduleLoadedStates[moduleData.name]="none";this._loadScriptOrStyle({module:moduleData.name,type:"js",file:moduleData.boot},function(){if(moduleData.name===moduleData.boot){context._afterLoadCheck(moduleData.name)}})}this._modulesCallbackList.push({type:"modules",modules:names,callback:callback});if(this._monitoringTimer===undefined){this._monitoringTimer=setTimeout(function checkNotLoadTimerFunc(){if(context._checkNotLoad()){context._monitoringTimer=setTimeout(checkNotLoadTimerFunc,1e4)}else{context._monitoringTimer=undefined}},1e4)}if(this._completeTimer===undefined){clearTimeout(this._completeTimer)}return this},initiate:function(moduleName,loadList){var moduleData=this._moduleList[moduleName],mainFile="";if(moduleData===undefined){this._error('TOM.boot: Модуль с названием "'+moduleName+'" не существует!');return}this._moduleLoadedStates[moduleName]="started";for(var i in loadList){loadList[i].file=loadList[i].file.replace(/(\*)/g,moduleName);if(mainFile===""&&loadList[i].main===true){mainFile=loadList[i].file}}moduleData.files=TOM._clone(loadList);for(var r in moduleData.files){var fileData=moduleData.files[r],requireList=this._prepareRequireList(moduleData,fileData.require);if(mainFile!==""&&fileData.file!==mainFile){requireList["files"].unshift(moduleData.path+mainFile)}moduleData.requires=moduleData.requires.concat(TOM._clone(requireList["modules"]));moduleData.files[r].requires=TOM._clone(requireList["files"])}for(var i in moduleData.files){var fileData=moduleData.files[i],loadFile=moduleData.path+fileData.file;requireList={files:moduleData.files[i].requires,modules:moduleData.requires};fileData.type=fileData.type||(/\.(css)$/.test(fileData.file)?"css":"js");if(!/\.(js|css)$/.test(fileData.file)){this._error("TOM.boot: В очередь загрузки подано имя файла без расширения - "+fileData.file);return}if(/^([а-яА-Я])/gi.test(fileData.file)){this._error("TOM.boot: В очередь загрузки подано имя файла с кирилическими символами - "+fileData.file);return}this._fileLoadedStates[loadFile]="none";(function(context,moduleName,fileData,loadedFile,requireList){fileData.checkRequireTimer=setTimeout(function checkRequireTimerFunc(){if(!context._requireCheck(requireList,{file:loadedFile,module:moduleName})){fileData.checkRequireTimer=setTimeout(checkRequireTimerFunc,50)}else{clearTimeout(fileData.checkRequireTimer)}},50)})(this,moduleName,fileData,loadFile,requireList)}return this},_prepareRequireList:function(moduleData,requires){if(requires===undefined){return{files:[],modules:[]}}var requires=requires instanceof Array?requires:[requires],requireList={files:[],modules:[]};for(var i in requires){var requireModuleName=requires[i];if(/\.css$/.test(requireModuleName)){continue}if(!/\.(js|css)(?:_|)$/.test(requireModuleName)&&/\.(.*?)$/.test(requireModuleName)){this._log("warn",'TOM.boot: Возможно в список зависимостей модуля: "'+moduleData.name+'" подано имя файла без расширения - "'+requireModuleName+'"')}else if(/\.js$/.test(requireModuleName)){requireModuleName=requireModuleName.replace(/(\*)/g,moduleData.name);requireList["files"].push(moduleData.path+requireModuleName)}else{requireList["modules"].push(requireModuleName)}}return requireList},_prepareModuleList:function(names,targetDir){var item=undefined,loadList=[];for(var i in names){var item=names[i],name=typeof item==="string"?item:item.name||"",baseURL=this._options.baseURL||"",targetDir=targetDir||"";if(typeof name==="string"&&/^([а-яА-Я])/gi.test(name)){this._error("TOM.boot: В очередь загрузки подано имя файла с кирилическими символами - "+name);return}var path=baseURL+(targetDir!==""?(!/\/$/gi.test(baseURL)?"/":"")+targetDir.replace(/(\*)/gi,name)+"/":"");if(!/^http/gi.test(name)){var boot=path+name+(!/\.js$/gi.test(name)?".boot.js":"")}else{var boot=name}loadList[name]={name:name,path:path,boot:boot,files:[],requires:[],initCount:0}}return loadList},_loadScriptOrStyle:function(fileData,callback){var context=this;if(fileData instanceof Object&&fileData.file!==""){this._fileLoadedStates[fileData.file]="started"}var setStateCallback=function(state,data){if(state==="complete"){var findData=context._findModuleFromFile(data.file);if(findData.script!==undefined&&findData.script.initialize!==undefined&&findData.script.initialize.length>0){state="needINIT"}}context._fileLoadedStates[data.file]=state;if(callback instanceof Function){callback(state,data)}};if(fileData.type==="css"||/\.css$/.test(fileData.file)){this._loadCSS(fileData,setStateCallback)}else if(fileData.type==="js"||/\.js$/.test(fileData.file)){this._loadJS(fileData,setStateCallback)}else{this._error('TOM.boot: Не верный тип загружаемого файла - "'+fileData.type+'"!');return}return this},_loadJS:function(fileData,callback){var context=this,head=document.getElementsByTagName("head"),url=fileData.file||"";var script=document.createElement("script");script.setAttribute("type","text/javascript");script.setAttribute("src",url+(!this._options.cache?"?t="+(new Date).getTime():""));script.done=false;script.onload=script.onreadystatechange=function(){if(!this.done&&(this.readyState===undefined||this.readyState==="complete")){this.done=true;this.onload=null;this.onreadystatechange=null;this.onerror=null;if(callback instanceof Function){callback.call(context,"complete",fileData)}head.removeChild(this)}};script.onerror=function(){if(!this.done){this.done=true;this.onload=null;this.onreadystatechange=null;this.onerror=null;if(callback instanceof Function){callback.call(context,"error",fileData)}}};this._interval(function(count){if(script.done){return false}if(count<1){script.done=true;if(callback instanceof Function){callback.call(context,"timeout",fileData)}}},100,300);if(head.length>0){head=head[0];head.appendChild(script)}return this},_loadCSS:function(fileData,callback){var context=this,head=document.getElementsByTagName("head"),url=fileData.file||"";var style=document.createElement("link");style.setAttribute("rel","stylesheet");style.setAttribute("type","text/css");style.setAttribute("href",url+(!this._options.cache?"?t="+(new Date).getTime():""));if(navigator.userAgent.indexOf("Chrome")===-1&&navigator.userAgent.indexOf("Safari")>-1){this._interval(function(count){if(style.sheet&&style.sheet.cssRules&&style.sheet.cssRules.length){if(callback instanceof Function){callback.call(context,"complete",fileData)}return false}if(count<1){style.done=true;if(callback instanceof Function){callback.call(context,"error",fileData)}}},100,300)}else{style.done=false;style.onload=function(){if(!this.done){this.done=true;if(callback instanceof Function){callback.call(context,"complete",fileData)}}};style.onerror=function(){if(!this.done){this.done=true;if(callback instanceof Function){callback.call(context,"error",fileData)}}};this._interval(function(count){if(style.done){return false}if(count<1){style.done=true;if(callback instanceof Function){callback.call(context,"timeout",fileData)}}},100,300)}if(head.length>0){head=head[0];head.appendChild(style)}return this},_interval:function(callback,time,count){var context=this;if(callback instanceof Function){if(callback.call(this,count)!==false&&count>=1){setTimeout(function(){count--;context._interval.call(context,callback,time,count)},time)}}},_requireCheck:function(requireList,load){var requireLoadCounter=0,requireFilesCount=requireList["files"]!==undefined?requireList["files"].length:0,requireModulesCount=requireList["modules"]!==undefined?requireList["modules"].length:0;for(var j=0;j<=1;j++){var requireCount=j===0?requireModulesCount:requireFilesCount;for(var i=0;i<requireCount;i++){var requireModule=undefined,requireFile=undefined;if(j===0&&requireList["modules"][i]!==undefined){requireModule=requireList["modules"][i];requireFile=this._moduleList[requireModule].boot}else if(j===1&&requireList["files"][i]!==undefined){requireFile=requireList["files"][i];if(!this._checkFileRequire(requireFile)){continue}}else{this._log("warn","TOM.boot: Прописана не верная зависимость!");continue}if(!this._checkAndLoad(requireFile,requireModule)){requireLoadCounter++}}if(j===0&&requireLoadCounter!==requireModulesCount){break}}if(requireLoadCounter===requireFilesCount+requireModulesCount){var context=this;if(load!==undefined){this._checkAndLoad(load.file,load.module)}return true}else{return false}},_checkFileRequire:function(fileData){var requireFilesCount=0;if(fileData===undefined){return true}if(fileData instanceof Object){var checkedFile=fileData.file,requireList=fileData.requires}else if(typeof fileData==="string"){var findData=this._findModuleFromFile(fileData),checkedFile=findData!==undefined&&findData.script!==undefined?findData.script.file:undefined,requireList=findData.script!==undefined?findData.script.requires:[];if(checkedFile===undefined&&findData.module!==undefined){return true}}else{this._error("TOM.boot: В функцию подано не верное имя файла!");return}return this._requireCheck({files:requireList})},_checkAndLoad:function(file,module){if((file===undefined||file!==undefined&&this._fileLoadedStates[file]!=="none")&&(module!==undefined&&this._moduleLoadedStates[module]!=="complete")){this._afterLoadCheck(module);return true}else if(file!==undefined&&this._fileLoadedStates[file]==="started"&&(module===undefined||module!==undefined&&this._moduleLoadedStates[module]!=="complete")){return true}else if(file!==undefined&&this._fileLoadedStates[file]==="none"&&(module===undefined||module!==undefined&&this._moduleLoadedStates[module]!=="complete")){var context=this;this._loadScriptOrStyle({file:file},function(state,fileData){if(state==="complete"||state==="needINIT"){context._afterLoadCheck(module)}});return true}else{return false}},_afterLoadCheck:function(moduleOrFile){if(moduleOrFile!==undefined&&moduleOrFile!==""){if(this._moduleList[moduleOrFile]===undefined){var findData=this._findModuleFromFile(moduleOrFile),moduleName=findData!==undefined&&findData.module!==undefined?findData.module.name:undefined}else{var moduleName=moduleOrFile}if(moduleName===undefined){this._error("TOM.boot: Не смогли найти модуль с именем: "+moduleName);return}var fileLoadCount=0,requireModulesLoadCount=0;for(var i in this._moduleList[moduleName].files){var fileData=this._moduleList[moduleName].files[i],fileLoadState=this._fileLoadedStates[this._moduleList[moduleName].path+fileData.file];if(fileLoadState==="complete"||fileLoadState==="needINIT"){fileLoadCount++}}for(var i in this._moduleList[moduleName].requires){var requireModule=this._moduleList[moduleName].requires[i];if(this._moduleLoadedStates[requireModule]==="complete"){requireModulesLoadCount++}}if(this._moduleLoadedStates[moduleName]!=="complete"&&fileLoadCount===TOM._objectLength(this._moduleList[moduleName].files)&&requireModulesLoadCount===TOM._objectLength(this._moduleList[moduleName].requires)){this._log("info",'TOM.boot: Модуль "'+moduleName+'": загружен полностью');if(this._checkAndInitialize(moduleName)){this._moduleLoadedStates[moduleName]="complete"}}}this._moduleCallbackCall()},_checkAndInitialize:function(moduleName){var context=this,notInitCount=1;var checkInitializeRequire=function(requireList){var initCount=0;for(var i in requireList){if(context._moduleList[requireList[i]]!==undefined){initCount++}else if(context._fileLoadedStates[requireList[i]]==="complete"||context._fileLoadedStates[requireList[i]]==="init"){initCount++}}return initCount===TOM._objectLength(requireList)};while(notInitCount>0){notInitCount=0;for(var i in this._moduleList[moduleName].files){var fileData=this._moduleList[moduleName].files[i],filePath=this._moduleList[moduleName].path+fileData.file,fileLoadState=this._fileLoadedStates[filePath];if(!checkInitializeRequire(fileData.requires)){notInitCount++;continue}if(fileData.initialize!==undefined&&fileLoadState!=="init"){if(fileData.initialize instanceof Function){var initState=true,initResult=fileData.initialize()||true;delete fileData.initialize()}else{var initializeList=fileData.initialize instanceof Array?fileData.initialize:[fileData.initialize];for(var j in initializeList){var initFunctionName=initializeList[j].replace(/(\*)/g,moduleName);if(this._initializeCall(initFunctionName)){this._fileLoadedStates[filePath]="init"}else{this._log("error","TOM.boot: Не смогли инициализировать: "+initFunctionName)}}}}}}return true},_initializeCall:function(initializeList){var initializeList=new Array(initializeList),initializeCount=0;for(var i in initializeList){if(initializeList[i]===undefined){continue}var pathList=initializeList[i].split("."),obj=window,initState=false,initResult=false;for(var j in pathList){obj=obj[pathList[j]];if(obj===undefined){this._error('TOM.boot: Ошибка при поиске объекта инициализации - "'+initializeList[i]+'"!');return}if((obj instanceof Object||obj instanceof Function)&&obj.initialize instanceof Function){initState=true;initResult=obj.initialize()||true;delete obj.initialize;break}}if(initState===false){if(obj instanceof Object&&obj.initialize===undefined){this._log("warn",'TOM.boot: Ошибка при инициализации - "'+initializeList[i]+'". Возможно инициализация происходила ранее!')}else{this._log("warn",'TOM.boot: Ошибка при инициализации - "'+initializeList[i]+'". Объект не существует!')}}if(initState===true&&initResult!==false){initializeCount++}}return initializeCount===initializeList.length},_moduleCallbackCall:function(){for(var i in this._modulesCallbackList){if(this._modulesCallbackList[i].type!=="modules"){continue}var moduleInitCount=0;for(var m in this._modulesCallbackList[i].modules){if(this._moduleLoadedStates[this._modulesCallbackList[i].modules[m]]==="complete"){moduleInitCount++}}if(moduleInitCount===TOM._objectLength(this._modulesCallbackList[i].modules)&&this._modulesCallbackList[i].callback instanceof Function){this._log("info","TOM.boot: ---! Загружены все модули данного этапа !---");this._modulesCallbackList[i].callback();delete this._modulesCallbackList[i]}}if(TOM._objectLength(this._modulesCallbackList)<=0){var context=this;this._completeTimer=setTimeout(function(){context._triggerCallback("complete")},500)}},_findModuleFromFile:function(file){if(this._moduleList[file]!==undefined&&this._fileLoadedStates[file]!==undefined){return{module:this._moduleList[file]}}else if(this._moduleList[file]!==undefined){return false}for(var i in this._moduleList){var moduleData=this._moduleList[i];if(moduleData.boot===file){return{module:moduleData}}for(var j in moduleData.files){if(moduleData.files[j]===file||moduleData.path+moduleData.files[j].file===file){return{module:moduleData,script:moduleData.files[j]}}}}},_checkNotLoad:function(){var notLoadedFiles=[],notInitFiles=[],notLoadedModules=[];for(var file in this._fileLoadedStates){var fileLoadState=this._fileLoadedStates[file];if(fileLoadState==="needINIT"){notInitFiles.push(file)}else if(fileLoadState!=="complete"&&fileLoadState!=="init"){notLoadedFiles.push(file+" ("+fileLoadState+")")}}for(var i in this._moduleList){var moduleLoadState=this._moduleLoadedStates[this._moduleList[i].name];if(moduleLoadState!=="complete"){notLoadedModules.push(this._moduleList[i].name+" ("+moduleLoadState+")")}}if(notLoadedFiles.length>0){this._log("info","TOM.boot: Не загрузились "+notLoadedFiles.length+" файлов: "+notLoadedFiles.join(", "))}if(notInitFiles.length>0){this._log("info","TOM.boot: Загрузились но не инициализировались "+notInitFiles.length+" файлов: "+notInitFiles.join(", "))}if(notLoadedModules.length>0){this._log("info","TOM.boot: Не загрузились "+notLoadedModules.length+" модулей: "+notLoadedModules.join(", "))}return notLoadedFiles.length>0||notLoadedModules.length>0||notInitFiles.length>0}};TOM.processor={_handlers:[],_log:function(type,msg){TOM._log("processor",type,msg);return this},_error:function(errorMsg,errorObj){TOM._error("processor",errorMsg,errorObj);return this},_triggerCallback:function(event,args){TOM._triggerCallback("processor",event,args);return this},callback:function(event,callback){TOM._callback("processor",event,callback);return this},removeCallback:function(event){TOM._removeCallback("processor",event);return this},bind:function(name,handler,params){if(handler===undefined||!(handler.constructor instanceof Function)){this.error("TOM.processor.bind: Подана не верная функция-обработчик - "+name);return}var params=params||{priority:""};if(name instanceof Object&&(name.pre!==undefined||name.post!==undefined)){var preNames=name.pre instanceof Array?name.pre:[name.pre],postNames=name.post instanceof Array?name.post:[name.post];for(var i in preNames){this.bind("pre-"+preNames[i].trim(),handler,params)}for(var j in postNames){this.bind("post-"+postNames[j].trim(),handler,params)}}else if(typeof name==="string"&&(name.indexOf(" ")>-1||name.indexOf(",")>-1)){var names=name.indexOf(" ")>-1&&name.indexOf(",")<=0?name.split(" "):name.split(",");for(var i in names){this.bind(names[i].trim(),handler,params)}}else{var stage=params.stage||"pre",label=params.label?params.label:handler.name,priority=params.priority!==undefined?params.priority:typeof params==="string"?params:"";if(typeof name==="string"){if(name.indexOf("post-")===0){var name=name.substr(5,name.length);stage="post"}else if(name.indexOf("pre-")===0){var name=name.substr(4,name.length)}}if(name===undefined||name===""){this.error("TOM.processor.bind: Подано не верное имя обрабатываемой функции - "+name);return}else if(/^([а-яА-Я])/gi.test(name)){this.error("TOM.processor.bind: Подано имя обрабатываемой функции с кирилическими символами - "+name);return}for(var i in this._handlers[name]){if(this._handlers[name][i]===handler){this._log("warn","TOM.processor.bind: Повторяющийся слушатель - "+name);return}}if(TOM._options["processor"].warning){var error=false;try{if(typeof eval(name)==="undefined"){error=true}}catch(e){error=true}if(error){for(var i in TOM.classes._list){if(name.indexOf(i)===0){error=false;break}}}if(error){this._log("warn","TOM.processor.bind: Слушатель цепляется на несуществующую ( или ещё не инициализированную ) функцию - "+name)}}if(this._handlers[name]===undefined){this._handlers[name]=[]}this._handlers[name].push({handler:handler,stage:stage,label:label,priority:priority})}return this},unbind:function(name,handler,params){var params=params||{},stage=params.stage||"pre";if(typeof name==="string"){if(name.indexOf("post-")===0){var name=name.substr(5,name.length);stage="post"}}if(/^([а-яА-Я])/gi.test(name)){this.error("TOM.processor.unbind: Подано название с кирилическими символами - "+name);return}if(this._handlers[name]!==undefined){for(var i in this._handlers[name]){var mainHandler=typeof handler==="string"?this._handlers[name][i].label||this._handlers[name][i].handler.name:this._handlers[name][i].handler,checkHandler=(typeof handler==="string"||handler instanceof Function)&&mainHandler===handler||handler===undefined?true:false;if(checkHandler&&this._handlers[name][i].stage===stage){this._handlers[name].splice(i,1)}}if(this._handlers[name].length<=0){delete this._handlers[name]}}return this},one:function(name,handler,params){var context=this,timeHash=$.toString((new Date).getTime()),params=params||{};params.label=params.label!==undefined&&params.label!==""?params.label:timeHash;var oneHandler=function(){context.unbind(name,params.label,params);return handler.apply(context,arguments)};this.bind(name,oneHandler,params);return this},signal:function(stage,name,sender,args){if(name===""){return}else if(this._handlers[name]===undefined){return this}this._handlers[name].sort(function(a,b){if(a.priority==="begin"&&b.priority!=="begin"){return 1}else if(a.priority!=="begin"&&b.priority==="begin"){return-1}return 0});for(var i in this._handlers[name]){if(this._handlers[name][i].handler instanceof Function&&this._handlers[name][i].stage===stage){var handler=this._handlers[name][i].handler,label=this._handlers[name][i].label,returnParam="",command="";if(sender!==undefined){sender._callMethod_=name;returnParam=handler.apply(sender,[sender,args]);delete sender._callMethod_}else{returnParam=this._handlers[name][i].handler({_callMethod_:name},args)}if(typeof returnParam==="boolean"){command=returnParam===false?"break":"unbind"}else if(typeof returnParam==="string"){command=returnParam?returnParam.split(" "):""}if(command.indexOf("unbind")>-1){this.unbind(name,this._handlers[name][i].handler,{stage:this._handlers[name][i].stage,label:label});this._log("info","TOM.processor: Контролируемый unbind - "+name+(label!==""?", ( метка: "+label+" )":""))}if(command.indexOf("break")>-1){this._log("info","TOM.processor: Прерываем дальнейшее выполнение обработчика - "+name+(label!==""?", ( метка: "+label+" )":""));return false}}}return this},proxy:function(object,parent,any){var context=this;this._proxyObject(object,function(method,methodName){if(methodName.indexOf("window.processor")>-1||method.__proxy__){return}method.__proxy__=true;var prototypeCount=0;for(var proto in method.prototype){prototypeCount++}if(method.__isClass__&&prototypeCount>0){for(var name in method.prototype){var proxyName=methodName+"."+name;if(!(method.prototype[name]instanceof Function)||name==="__checkClassName__"||name.indexOf("__parent")===0){continue}method.prototype[name]=context._signalProxy(method.prototype[name],proxyName)}}else{return context._signalProxy(method,methodName)}},parent,undefined,any);return this},_proxyObject:function(object,proxyCallback,parent,args,any){if(object instanceof Object&&(any||object.constructor===Object)){for(var member in object){var parentName=object.__scopeName__||object.__className__||parent;if(!parentName){throw new Exception("TOM.processor: Ошибка при проксировании объекта. Не указано имя родительского объекта!")}if(object[member]instanceof Function){object[member]=proxyCallback(object[member],(parentName?parentName+".":"")+member,args)||object[member]}else{this._proxyObject(object[member],proxyCallback,(parentName?parentName+".":"")+member,args)}}}},_signalProxy:function(method,methodName){var context=this,method=method,methodName=methodName,callback=function(){if(context.signal("pre",methodName,this,arguments)!==false){var mainResult=method.apply(this,arguments),postResult=context.signal("post",methodName,this,arguments);return mainResult}};return callback}};if(typeof Object.create!=="function"){Object.create=function(){var Func=function(){};return function(prototype){if(arguments.length>1){throw Error("Второй аргумент не поддерживается!")}if(typeof prototype!=="object"){throw TypeError("В функцию должен быть передан объект!")}Func.prototype=prototype;var result=new Func;Func.prototype=null;return result}}()}TOM.classes={_list:[],_log:function(type,msg){TOM._log("classes",type,msg);return this},_error:function(errorMsg,errorObj){TOM._error("classes",errorMsg,errorObj);return this},_triggerCallback:function(event,args,context){TOM._triggerCallback("classes",event,args,context);return this},callback:function(event,callback){TOM._callback("classes",event,callback);return this},removeCallback:function(event){TOM._removeCallback("classes",event);return this},create:function(classScope,className,inheritedClass){var context=this,newClass=undefined,classConstructor=undefined,classScopeName=classScope.__scopeName__||"",realClassScope=undefined,functionList=undefined;if(classScope instanceof Object){realClassScope=classScope;classScope=classScopeName}else if(typeof classScope==="string"&&classScope!==""&&window[classScope]!==undefined){realClassScope=window[classScope]}else{this._error('TOM.class: Ошибка при создании класса: не указана "область видимости"!');return}if(inheritedClass===undefined){this._error("TOM.class: Класс от которого мы собрались наследоваться - не существует!");return}if(arguments[3]instanceof Function){classConstructor=arguments[3];if(arguments[4]instanceof Function){functionList=[].slice.call(arguments,4)}else if(arguments[4]instanceof Array||arguments[4]instanceof Object){functionList=arguments[4]}else if(arguments[4]!==undefined){this._error("TOM.class: Ошибка при создании класса: не верные входные данные!");return}}else if(arguments[3]instanceof Array){classConstructor=arguments[3][1];functionList=[].slice.call(arguments[3],2);if(!(classConstructor instanceof Function)){this._error("TOM.class: Ошибка при создании класса: не верные входные данные!");return}}else if(arguments[3]instanceof Object&&arguments["constructor"]instanceof Function){classConstructor=arguments[3]["constructor"];var copyObject=TOM._clone(arguments[3]);delete copyObject["constructor"];functionList=copyObject}else{this._error("TOM.class: Ошибка при создании класса: не верные входные данные!");return}var newClass=function(){var args=Array.prototype.slice.call(arguments,1),constructorFullName=(this.__classScopeName__!==""?this.__classScopeName__+"."+this.__className__:this.__className__)+".constructor";context._triggerCallback("pre-constructor",[constructorFullName,args],this);classConstructor.apply(this,arguments);context._triggerCallback("post-constructor",[constructorFullName,args],this)};newClass.prototype.constructor=classConstructor;newClass.__isClass__=newClass.prototype.__isClass__=true;newClass.__className__=newClass.prototype.__className__=className;newClass.__classScopeName__=newClass.prototype.__classScopeName__=classScopeName;newClass.__classFullName__=(newClass.__classScopeName__!==""?newClass.__classScopeName__+".":"")+newClass.__className__;newClass.__classScope__=newClass.prototype.__classScope__=classScope||{};newClass.__checkClassName__=newClass.prototype.__checkClassName__=function(className,checkParent){var checkedName=this.__classScopeName__!==""?this.__classScopeName__+"."+this.__className__:this.__className__,checkState=checkedName===className;if(!checkState&&checkParent){var parentClass=this.__parent__,parentCheckState=false,parentCheckedClassName="";while(true){if(parentClass!==undefined){parentCheckedClassName=parentClass.__classScopeName__!==""?parentClass.__classScopeName__+"."+parentClass.__className__:parentClass.__className__;if(parentCheckedClassName===className){parentCheckState=true;break}parentClass=parentClass.__parent__}else{break}}}return checkState||parentCheckState};newClass.prototype.destructor=function(){for(var name in this){delete this[name]}};newClass.prototype.destroy=function(){return this.destructor.apply(this,arguments.length>0?arguments:arguments.callee.caller.arguments)};if(functionList instanceof Array||functionList instanceof Object){for(var indexOrName in functionList){var functionName=!(functionList[indexOrName]instanceof Function)||functionList instanceof Object&&functionList[indexOrName].name===""?indexOrName:functionList[indexOrName].name;if(functionName===undefined||functionName!==""){newClass.prototype[functionName]=functionList[indexOrName]}else{this._log("warn","TOM.class: При создании класса не удалось скопировать параметр/функцию - не правильное имя!")}}}if(inheritedClass instanceof Object||inheritedClass instanceof Function){this.inherit(newClass,inheritedClass)}if(realClassScope!==undefined){realClassScope[className]=newClass}this._list[newClass.__classFullName__]=newClass;context._triggerCallback("create",[newClass]);return newClass},inherit:function(childClass,parentClass){if(parentClass===undefined||parentClass===""){this._error("Ошибка при наследовании класса: родитель не указан или не создан!");return}var parentName=parentClass.__className__||parentClass.name||"";if(parentName===""){this._error("Ошибка при наследовании класса: у класса нет имени!");return}var childPrototype=childClass.prototype;childClass.prototype=Object.create(parentClass.prototype);childClass.prototype.constructor=childClass;for(var childMethodName in childPrototype){childClass.prototype[childMethodName]=childPrototype[childMethodName]}childClass.prototype.__parent__=parentClass.prototype;childClass.prototype.__parentParameter__=function(parameterName){if(parameterName!==""&&this.__parent__.hasOwnProperty(parameterName)){return this.__parent__[parameterName]}else if(parameterName===""){this._log("warn",this.__className__+": Не указано имя параметра/функции!")}else{this._log("warn",this.__className__+': Параметр/функция "'+parameterName+'" не существует!')}};childClass.prototype.__parentFunction__=function(functionName,callArguments){var callFunction=this.__parentParameter__(functionName),callArguments=callArguments instanceof Array?callArguments:[callArguments];if(!(callFunction instanceof Function)){this._log("warn",this.__className__+': Функции "'+functionName+'" не существует');return}return callFunction.apply(this,callArguments)};childClass.prototype.__parentCall__=function(){var callerObject=arguments.callee.caller,callerFunction=arguments.callee.caller.name||"",callerArguments=arguments.length>0?arguments:arguments.callee.caller.arguments;if(callerFunction!==""&&this.__parent__[callerFunction]instanceof Function){
var caller=callerObject.prototype.__className__===this.__parent__.__className__?this.__parent__:this;return caller.__parent__[callerFunction].apply(this,callerArguments)}else if(callerFunction===""){this._log("warn",this.__className__+": У вызывающей функции нет имени!")}else{this._log("warn",this.__className__+': Функции "'+callerFunction+'" не существует!')}};return this}};if(TOM.classes!==undefined&&TOM.processor!==undefined){TOM.classes.callback("create",function(newClass){TOM.processor.proxy(newClass,newClass.__classFullName__)});TOM.classes.callback("pre-constructor",function(constructorFullName,args){TOM.processor.signal("pre",constructorFullName,this,args)});TOM.classes.callback("post-constructor",function(constructorFullName,args){TOM.processor.signal("post",constructorFullName,this,args)})}})(window);